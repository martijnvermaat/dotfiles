#!/bin/bash

# Synchronize remote backup
#
# First argument is index of remote backup site
#
# To run periodically from a scheduler like cron, for example:
#
#   $ crontab -l
#   # Synchronize remote backup
#   30 03 * * * ~/bin/sync-remote-backup 1 >> /var/log/sync-priscilla-backup 2>&1
#
# Copyright (c) 2007-2009, Martijn Vermaat

# Dreamhost configuration
SITE[1]="Dreamhost"
BANDWIDTH[1]=60
BACKUP_SERVER[1]=backup.dreamhost.com
BACKUP_USER[1]=b292235
BACKUP_DIR[1]="~/audrey"

# Priscilla configuration
#SITE[1]="Priscilla"
#BANDWIDTH[1]=400
#BACKUP_SERVER[1]=priscilla
#BACKUP_USER[1]=martijn
#BACKUP_DIR[1]="/backup/michelle"

case "$1" in
    1)
        echo
        echo "$(/bin/date)   Starting synchronizing remote backup (${SITE[$1]})"
        ;;
    *)
        echo
        echo "$(/bin/date)   Not a valid backup site: $1"
        echo
        exit 1
        ;;
esac

. /home/martijn/bin/prepare-backup

# Synchronize /etc
/usr/bin/rsync --protocol=29 -e ssh -za --bwlimit=${BANDWIDTH["$1"]} --delete /etc/ ${BACKUP_USER["$1"]}@${BACKUP_SERVER["$1"]}:${BACKUP_DIR["$1"]}/etc

# Synchronize home
/usr/bin/rsync --protocol=29 -e ssh -za --bwlimit=${BANDWIDTH["$1"]} --delete --delete-excluded --exclude-from /home/martijn/.backup-filter /home/martijn/ ${BACKUP_USER["$1"]}@${BACKUP_SERVER["$1"]}:${BACKUP_DIR["$1"]}/home

echo "$(/bin/date)   Finished synchronizing remote backup"
echo
