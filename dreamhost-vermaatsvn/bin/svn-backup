#!/bin/bash

# This should be a shell script that creates a backup of all Subversion
# repositories in a given directory and gzips the result.
#
# A command line argument may be given to indicate the type of the backup,
# which should be 'daily', 'weekly', or 'monthly'. This is used to generate
# a location for the backup. Default backup type is 'daily'.
#
# It also copies the backup to a static directory (latest backup).
#
# To run periodically from a scheduler like cron, for example:
#
#   $ crontab -l
#   # Daily at 03:07
#     7 3 * * *  ~/bin/svn-backup daily >> /var/log/svn-backup 2>&1
#   # Weekly at 04:07
#     7 4 1 * *  ~/bin/svn-backup weekly >> /var/log/svn-backup 2>&1
#   # Monthly at 05:07
#     7 5 * * 1  ~/bin/svn-backup monthly >> /var/log/svn-backup 2>&1
#
# Copyright (c) 2007, Martijn Vermaat


# Configuration

# Directory containing repositories
# All direct subdirectories of this directory are regarded as repository
# locations to be backed up
REPOSITORIES=/home/vermaatsvn/svn

# Backup directory
BACKUPS=/home/vermaatsvn/backups/svn

# Receive type of backup from command line argument
TYPE="$1"

# End of configuration


echo

# We use the current date in the backup path
DATE=`/bin/date '+%F'`

# Check for a sane type
case "$TYPE" in
    daily   ) TYPE=daily ;;
    weekly  ) TYPE=weekly ;;
    monthly ) TYPE=monthly ;;
    *       ) TYPE=daily ;;
esac

echo
echo "Starting subversion backups procedure at $DATE"
echo
echo `/bin/date`

# Backup dir will contain type and date
BACKUP_DIR=$BACKUPS/$TYPE/$DATE

# Check if backup is needed
if [ -d $BACKUP_DIR ]; then
    echo
    echo `/bin/date`
    echo
    echo "Backup already exists, quiting"
    exit 1
fi

echo
echo "Creating directory $BACKUP_DIR"

# Create backup dir
/bin/mkdir $BACKUP_DIR

# Loop over repositories
for REPOSITORY in `/usr/bin/find $REPOSITORIES -type d -mindepth 1 -maxdepth 1`; do

    BACKUP_FILE=`/usr/bin/basename $REPOSITORY`.dump

    echo
    echo "Running svnadmin dump -q $REPOSITORY > $BACKUP_DIR/$BACKUP_FILE"

    # Create backup with svnadmin dump
    /usr/bin/svnadmin dump -q $REPOSITORY > $BACKUP_DIR/$BACKUP_FILE

    echo "Running gzip"

    # gzip backup
    /bin/gzip --force $BACKUP_DIR/$BACKUP_FILE

    echo "Removing old latest backup"

    # Remove old latest backup
    /bin/rm $BACKUPS/latest/$BACKUP_FILE.gz

    echo "Copying backup to latest backup"

    # Copy backup to latest backup
    /bin/cp $BACKUP_DIR/$BACKUP_FILE.gz $BACKUPS/latest/

done

# TODO: remove all but latest 10 daily backups

echo
echo `/bin/date`
echo
echo "Backups completed and located at $BACKUP_DIR"
echo "Copies are written to $BACKUPS/latest"
echo
