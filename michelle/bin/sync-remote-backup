#!/bin/bash

# Synchronize remote backup
#
# First argument is index of remote backup site
#
# To run periodically from a scheduler like cron, for example:
#
#   $ crontab -l
#   # Synchronize remote backup
#   30 03 * * * ~/bin/sync-remote-backup 1 >> /var/log/sync-priscilla-backup 2>&1
#
# Copyright (c) 2007-2009, Martijn Vermaat

# Priscilla configuration
SITE[1]="Priscilla"
BANDWIDTH[1]=400
BACKUP_SERVER[1]=priscilla
BACKUP_USER[1]=martijn
BACKUP_DIR[1]="/backup/michelle"

# Dreamhost configuration
SITE[2]="Dreamhost"
BANDWIDTH[2]=60
BACKUP_SERVER[2]=backup.dreamhost.com
BACKUP_USER[2]=b292235
BACKUP_DIR[2]="~/michelle"

case "$1" in
    1 | 2)
        echo
        echo "$(/bin/date)   Starting synchronizing remote backup (${SITE[$1]})"
        ;;
    *)
        echo
        echo "$(/bin/date)   Not a valid backup site: $1"
        echo
        exit 1
        ;;
esac

# Synchronize /etc
/usr/bin/rsync --protocol=29 -e ssh -za --bwlimit=${BANDWIDTH["$1"]} --delete /etc/ ${BACKUP_USER["$1"]}@${BACKUP_SERVER["$1"]}:${BACKUP_DIR["$1"]}/etc

# Synchronize home
/usr/bin/rsync --protocol=29 -e ssh -za --bwlimit=${BANDWIDTH["$1"]} --delete --delete-excluded --exclude-from /home/martijn/.backup-filter /home/martijn/ ${BACKUP_USER["$1"]}@${BACKUP_SERVER["$1"]}:${BACKUP_DIR["$1"]}/home

echo "$(/bin/date)   Finished synchronizing remote backup"
echo
