#!/bin/sh

# Mirror the latest repository backups from a remote host using rsync and
# backup any changes. Keep a maximum number of backups.
#
# To run periodically from a scheduler like cron, for example:
#
#   $ crontab -l
#   # Retreive latest repository backups daily
#   30 03 * * * ~/bin/copy-svn-backup >> /var/log/copy-svn-backup 2>&1
#
# Copyright (c) 2007, Martijn Vermaat

REMOTE_HOST=vermaat.name
REMOTE_USER=vermaatsvn
REMOTE_DIR=/home/vermaatsvn/backups/svn/latest/
MIRROR_DIR=/backup/subversion
KEEP=10

echo
echo "$(/bin/date)   Running rsync"

# Use rsync to mirror the latest repository backups
/usr/bin/rsync -e ssh -avzb --backup-dir $MIRROR_DIR/$(/bin/date '+%F') \
    $REMOTE_USER@$REMOTE_HOST:$REMOTE_DIR $MIRROR_DIR/latest

# Remove old backups of this type
for BACKUP in $(/bin/ls $MIRROR_DIR | grep -v latest | head -n -$KEEP); do

    echo
    echo "Removing old backup in $MIRROR_DIR/$BACKUP"

    # Remove old backup
    /bin/rm -r $MIRROR_DIR/$BACKUP

done

echo "$(/bin/date)   Finished rsync"
